$jq=jQuery.noConflict(),Array.max=function(a){return Math.max.apply(Math,a)},Array.prototype.flatten=function(){return $jq.map(this,function(a){if(a)return a})};var PfamGraphic={_canvases:{},_middleClickListenerAdded:!1,initialize:function(a,b){this._imageParams={headSizeCircle:3,headSizeSquare:6,headSizeDiamond:4,headSizeArrow:3,headSizePointer:3,headSizeLine:3,sequenceEndPadding:2,xOffset:0,yOffset:0,defaultMarkupHeight:20,lollipopToLollipopIncrement:7,bridgeToBridgeIncrement:2,bridgeToLollipopIncrement:5,largeJaggedSteps:6,fontSize:"0.8em",regionHeight:20,motifHeight:14,motifOpacity:.6,labelPadding:3,residueWidth:.5,xscale:1,yscale:1,envOpacity:.6,highlightWeight:1,highlightColour:"#000000"},this._options={baseUrl:"",imageMap:!0,labels:!0,tips:!0,tipStyle:"pfam",newCanvas:!0},this._markupSpec={valignValues:["top","bottom"],linesStyleValues:["mixed","bold","dashed"],lollipopHeadValues:["diamond","circle","square","arrow","pointer","line"],regionEndValues:["curved","straight","jagged","arrow"]},this._heights={},this._areasHash={},this._cache={},a!==undefined&&this.setParent(a),b!==undefined&&this.setSequence(b),this._saveLevel=0},setParent:function(a){return this._parent=$jq(a),(this._parent===undefined||this._parent===null)&&this._throw("couldn't find the parent node"),this},getParent:function(){return this._parent},setCanvas:function(a){return this._canvas=a,(this._canvas===undefined||this._canvas===null)&&this._throw("couldn't find the canvas node"),this._canvas.getContext===undefined&&this._throw("canvas is not supported"),this._context=this._canvas.getContext("2d"),this._context===undefined&&this._throw("couldn't create a 2d context from canvas"),this._areasList=[],this},getCanvas:function(){return this._canvas},setImageParams:function(a){return this._imageParams=a,this._applyImageParams=!0,this},getImageParams:function(){return this._imageParams},setNewCanvas:function(a){return this._options.newCanvas=a,this},getNewCanvas:function(){return this._options.newCanvas},setBaseUrl:function(a){return this._options.baseUrl=a,this},getBaseUrl:function(){return this._options.baseUrl},setSequence:function(a){return a.length===undefined&&this._throw("must specify a sequence length"),isNaN(a.length)&&this._throw("sequence length must be a valid number"),parseInt(a.length,10)<=0&&this._throw("sequence length must be a positive integer"),a.regions!==undefined?typeof a.regions!="object"&&this._throw("'regions' must be a valid object"):a.regions=[],a.markups!==undefined?typeof a.markups!="object"&&this._throw("'markups' must be a valid object"):a.markups=[],a.motifs!==undefined?typeof a.motifs!="object"&&this._throw("'motifs' must be a valid object"):a.motifs=[],a.options!==undefined&&(typeof a.options!="object"&&this._throw("'options' must be a valid object"),this._options=Object.extend(this._options,a.options)),a.imageParams!==undefined&&(typeof a.imageParams!="object"&&this._throw("'imageParams' must be a valid object"),this.setImageParams(a.imageParams)),this._sequence=JSON.parse(a),this._walkSequence(),this._imageWidth=this._sequence.length*this._imageParams.residueWidth+2,this._regionHeight=this._imageParams.regionHeight,this._seqHeight=Math.round(this._regionHeight/6),this._seqStep=Math.round(this._seqHeight/5),this._buildMarkups(),this._canvasHeight=Array.max([this._heights.lollipops.upMax,this._heights.bridges.upMax,this._regionHeight/2+1])+Array.max([this._heights.lollipops.downMax,this._heights.bridges.downMax,this._regionHeight/2+1])+1,this._canvasHeight*=this._imageParams.yscale,this._sequence.highlight!==undefined&&(this._canvasHeight+=5+Math.ceil(this._imageParams.highlightWeight/2)),this._canvasWidth=this._imageWidth+1+this._imageParams.sequenceEndPadding*2,this._canvasWidth*=this._imageParams.xscale,this._baseline=Array.max([this._heights.lollipops.upMax||0,this._heights.bridges.upMax||0,(this._imageParams.regionHeight||0)/2])+1,this},getSequence:function(){return this._sequence},getDimensions:function(){if(this._canvasWidth===undefined||this._canvasHeight===undefined)return null;var a=[this._canvasWidth,this._canvasHeight];return a.width=this._canvasWidth,a.height=this._canvasHeight,a},getBaseline:function(){return this._baseline===undefined?null:this._baseline},getAreas:function(){return[this._areasList,this._areasHash]},render:function(a,b){return b!==undefined&&this.setSequence(b),a!==undefined&&this.setParent(a),this._sequence===undefined&&this._throw("sequence was not supplied"),this._options.newCanvas&&this._parent===undefined&&this._throw("parent node was not supplied"),(!this._canvas||this._options.newCanvas)&&this._buildCanvas(this._canvasWidth,this._canvasHeight),this._draw(),this._canvases[this._canvas]={parentEl:this._parent,areas:this._areasList},this},_throw:function(a){throw{name:"PfamGraphicException",message:a,toString:function(){return this.message}}},_walkSequence:function(){var a=this._sequence;a.length=this._parseInt(a.length);for(j in[a.motifs,a.regions,a.markups])for(i in["start","end","aliStart","aliEnd"])i=this._parseInt(i)},_parseInt:function(a){if(a===undefined)return;var b=parseInt(a,10);return b!=="NaN"?b:a},_buildCanvas:function(a,b){var c=document.createElement("canvas");c.width=a,c.height=b,$jq(this._parent).append(c),typeof G_vmlCanvasManager!="undefined"&&(c=G_vmlCanvasManager.initElement(c));var d=this._parent.closest("div");d&&a>d.scrollWidth&&this._parent.addClassName("canvasScroller"),this.setCanvas(c)},_addListeners:function(){var a=window.Prototip&&this._options.tips;this._inside=null,$jq(this._canvas).click(function(a){this._handleClick(a)}.bind(this))},_handleClick:function(a){var b=a.findElement("canvas"),c=b.identify(),d=this._canvases[c];if(d===undefined)return;a.stop();var e=d.areas,f=b.cumulativeOffset(),g=f[0],h=f[1],i=a.pointerX()-g,j=a.pointerY()-h,k=null;e.reverse().each(function(a){if(i>a.coords[0]&&i<a.coords[2]&&j>a.coords[1]&&j<a.coords[3])throw k=a,$break});if(k&&k.href){var l;this._options.baseUrl&&!this._options.baseUrl.empty()?l=this._options.baseUrl+k.href:l=k.href,a.isMiddleClick()?window.open(l):window.location=l}},_buildMarkups:function(){var a={lollipops:{up:[],down:[],markups:[],downMax:0,upMax:0},bridges:{up:[],down:[],markups:[],downMax:0,upMax:0}},b=[],c=this._imageParams,d=this._markupSpec,e={},f=this._sequence.markups;for(var g=-1,h;h=f[++g];){var i=Math.floor(h.start);i==="NaN"&&this._throw("markup start position is not a number: '"+h.start+"'"),e[h.start]===undefined&&(e[h.start]=[]),e[h.start].push(h)}e=$jq.map(e,function(a){if(a)return a});var j=this._imageParams.residueWidth;for(var g=-1,h;h=e[++g];){if(typeof h!="object")continue;var i=Math.floor(h.start);i==="NaN"&&this._throw("markup start position is not a number: '"+h.start+"'");if(h.end===undefined)a.lollipops.markups.push(h);else{b.push(h);continue}h.v_align!==undefined&&!d.valignValues.include(h.v_align)&&this._throw("markup 'v_align' value is not valid: '"+h.v_align+"'"),h.headStyle!==undefined&&!($jq.inArray(h.headStyle,d.lollipopHeadValues)>-1)&&this._throw("markup 'headStyle' value is not valid: '"+h.headStyle+"'");var k=h.v_align===undefined||h.v_align==="top",l=k?a.lollipops.up:a.lollipops.down;if(l[i-1/j]!==undefined||l[i]!==undefined||l[i+1/j]!==undefined){var m=Array.max(l.slice(i-1/j,i+1/j));l[i]=m+c.lollipopToLollipopIncrement}else l[i]=c.defaultMarkupHeight;var n=c["headSize"+h.headStyle.charAt(0).toUpperCase()+h.headStyle.slice(1)];k?a.lollipops.upMax=Math.max(l[i]+n,a.lollipops.upMax):a.lollipops.downMax=Math.max(l[i]+n,a.lollipops.downMax)}for(var g=-1,o;o=b[++g];){var p={markup:o};a.bridges.markups.push(p);var i=Math.floor(o.start);i==="NaN"&&this._throw("bridge start position is not a number: '"+o.start+"'");var q=Math.floor(o.end);q==="NaN"&&this._throw("bridge end position is not a number: '"+o.end+"'"),p.up=o.v_align===undefined||o.v_align==="top";var r=p.up?a.lollipops.up:a.lollipops.down,s=p.up?a.bridges.up:a.bridges.down,t=Array.max(s.slice(i,q).flatten()),u=c.defaultMarkupHeight;t!==undefined&&$jq.inArray(u,s.slice(i,q).flatten())>-1&&(u=t+c.bridgeToBridgeIncrement);var v=Array.max(r.flatten().slice(i-4,q+4));v!==undefined&&v+c.bridgeToLollipopIncrement>=u&&(u=v+c.bridgeToLollipopIncrement);while($jq.inArray(u,s.slice(i,q).flatten())>-1)u+=c.bridgeToBridgeIncrement,console.log("PfamGraphic._buildMarkups: found overlapping bridge; setting bridge height to %d",u);p.height=u;for(var w=i;w<q+1;w++)s[w]===undefined&&(s[w]=[]),s[w].push(u);p.up?a.bridges.upMax=Math.max(u,a.bridges.upMax)+2:a.bridges.downMax=Math.max(u,a.bridges.downMax)+2}this._heights=a},_draw:function(){this._context.save();if(this._applyImageParams){var a=this._imageParams;this._context.translate(a.xOffset,a.yOffset),this._context.scale(a.xscale,a.yscale),this._context.translate(a.sequenceEndPadding,0),this._applyImageParams=!1}var b=this._drawSequence();for(var c=-1,d;d=this._heights.bridges.markups[++c];){if(d.display!==undefined&&d.display!==null&&!d.display)continue;this._drawBridge(d)}for(var c=-1,e;e=this._heights.lollipops.markups.reverse()[++c];){if(e.display!==undefined&&e.display!==null&&!e.display)continue;this._drawLollipop(e)}for(var c=-1,f;f=this._sequence.regions[++c];){if(f.display!==undefined&&f.display!==null&&!f.display)continue;this._drawRegion(f)}if(this._sequence.motifs)for(var c=-1,g;g=this._sequence.motifs[++c];){if(g.display!==undefined&&g.display!==null&&!g.display)continue;this._drawMotif(g)}this._sequence.highlight!==undefined&&parseInt(this._sequence.highlight.start,10)&&parseInt(this._sequence.highlight.end,10)&&this._drawHighlight(),this._context.restore()},_drawSequence:function(){this._topOffset=Math.floor(this._baseline-this._seqHeight/2),this._botOffset=Math.floor(this._baseline+this._seqHeight/2+1),this._context.save();var a=this._context.createLinearGradient(1,this._topOffset,1,this._botOffset);a.addColorStop(0,"#999999"),a.addColorStop(.5,"#eeeeee"),a.addColorStop(.7,"#cccccc"),a.addColorStop(1,"#999999"),this._context.fillStyle=a,this._context.fillRect(1,this._topOffset+.5,this._imageWidth-1,this._seqHeight/2*3),this._context.restore();var b=this._imageParams.xOffset,c=this._imageParams.yOffset;return{label:"sequence",text:"sequence",coords:[b,c+this._topOffset,b+this._imageWidth,c+this._topOffset+this._seqStep*5]}},_drawLollipop:function(a){var b=a.start,c=a.v_align===undefined||a.v_align==="top",d=Math.floor(b*this._imageParams.residueWidth)+1.5,e,f;c?(e=Math.round(this._topOffset+1)-.5,f=Math.floor(e-this._heights.lollipops.up[b]+(this._baseline-this._topOffset)+1)):(e=Math.round(this._botOffset+1)-.5,f=Math.ceil(e+this._heights.lollipops.down[b]-(this._botOffset-this._baseline)-1)),this._context.save(),this._context.beginPath(),this._context.moveTo(d,e),this._context.lineTo(d,f),this._context.strokeStyle=a.lineColour||"#000000",this._context.stroke(),this._context.closePath(),this._context.restore();var g=this._imageParams.xOffset,h=this._imageParams.yOffset,i=[e,f].sort(function(a,b){return a-b}),j={start:b,type:"lollipop",coords:[g+Math.floor(d)-1,h+i[0]-1,g+Math.floor(d)+1,h+i[1]+1]};this._areasList.push(j),a.href!==undefined&&(j.href=a.href);var k={};if(a.metadata){var l=a.metadata;k.title=l.type||"Annotation",k.body='<div class="tipContent">  <dl>    <dt>Description:</dt>    <dd>'+l.description+"</dd>"+"    <dt>Position:</dt>"+"    <dd>"+l.start+"</dd>"+"    <dt>Source:</dt>"+"    <dd>"+(l.database||'<span class="na">n/a</span>')+"</dd>"+"  </dl>"+"</div>"}j.tip=k,a.headStyle&&this._drawLollipopHead(d,e,f,b,c,a.headStyle,a.colour,a.lineColour,j.tip,a.metadata)},_drawLollipopHead:function(a,b,c,d,e,f,g,h,i,j){var k=this._imageParams.xOffset,l=this._imageParams.yOffset,m,n;this._context.save();switch(f){case"circle":m=this._imageParams.headSizeCircle,this._context.beginPath(),this._context.arc(a,c,m,0,Math.PI*2,"true"),this._context.fillStyle=g||"red",this._context.fill(),this._areasList.push({tip:i,type:"lollipop-head",shape:"circle",colour:g||"red",start:d,coords:[k+a-m,l+c-m,k+a+m,l+c+m]});break;case"square":n=this._imageParams.headSizeSquare/2,this._context.beginPath(),this._context.moveTo(a-n,c-n),this._context.lineTo(a-n,c+n),this._context.lineTo(a+n,c+n),this._context.lineTo(a+n,c-n),this._context.lineTo(a-n,c-n),this._context.closePath(),this._context.fillStyle=g||"rgb(100, 200, 9)",this._context.fill(),this._areasList.push({tip:i,type:"lollipop-head",start:d,colour:g||"rgb(100, 200, 9)",coords:[k+a-n,l+c-n,k+a+n,l+c+n]});break;case"diamond":n=this._imageParams.headSizeDiamond,this._context.beginPath(),this._context.moveTo(a-n,c),this._context.lineTo(a,c+n),this._context.lineTo(a+n,c),this._context.lineTo(a,c-n),this._context.lineTo(a-n,c),this._context.closePath(),this._context.fillStyle=g||"rgb(100, 200, 9)",this._context.fill(),this._areasList.push({tip:i,ty2pe:"lollipop-head",shape:"poly",start:d,colour:g||"rgb(100, 200, 9)",coords:[k+a-n,l+c-n,k+a+n,l+c+n]});break;case"line":n=this._imageParams.headSizeLine,this._context.beginPath(),this._context.moveTo(a,c-n),this._context.lineTo(a,c+n),this._context.closePath(),this._context.strokeStyle=g||"rgb(50, 40, 255)",this._context.stroke(),this._areasList.push({tip:i,type:"lollipop-head",start:d,colour:g||"rgb(50, 40, 255)",coords:[k+a-1,l+c-n-1,k+a+1,l+c+n+1]});break;case"arrow":n=this._imageParams.headSizeArrow;var o;e?(this._context.beginPath(),this._context.moveTo(a,c),this._context.lineTo(a,c-n),this._context.strokeStyle=h||"#000000",this._context.stroke(),this._context.beginPath(),this._context.moveTo(a-n,c+n*.5),this._context.lineTo(a,c-n),this._context.lineTo(a+n,c+n*.5),o=[k+a-n,l+c,k+a+n,l+c+n*.5]):(this._context.beginPath(),this._context.moveTo(a,c),this._context.lineTo(a,c+n),this._context.strokeStyle=h||"#000000",this._context.stroke(),this._context.beginPath(),this._context.moveTo(a-n,c-n*.5),this._context.lineTo(a,c+n),this._context.lineTo(a+n,c-n*1.5),o=[k+a-n,l+c-n*1.5,k+a+n,l+c-n]),this._context.strokeStyle=g||"rgb(50, 40, 255)",this._context.stroke(),this._areasList.push({tip:i,type:"lollipop-head",colour:g||"rgb(50, 40, 255)",start:d,shape:"poly",coords:o});break;case"pointer":n=this._imageParams.headSizePointer,this._context.beginPath();var o;e?(this._context.moveTo(a-n,b-n*1.5),this._context.lineTo(a,b),this._context.lineTo(a+n,b-n*1.5),o=[k+a-n,l+b,k+a+n,l+b-n]):(this._context.moveTo(a-n,b+n*1.5),this._context.lineTo(a,b),this._context.lineTo(a+n,b+n*1.5),o=[k+a-n,l+b+n,k+a+n,l+b]),this._context.strokeStyle=g||"rgb(50, 40, 255)",this._context.stroke(),this._areasList.push({tip:i,type:"lollipop-head",colour:g||"rgb(50, 40, 255)",start:d,shape:"poly",coords:o})}this._context.restore()},_drawBridge:function(a){this._context.save();var b=a.markup.start,c=a.markup.end,d=a.height,e=a.up,f="#000000",g=Math.floor(b*this._imageParams.residueWidth)+1.5,h=Math.floor(c*this._imageParams.residueWidth)+1.5,i=Math.round(e?this._topOffset:this._botOffset)+.5,j,k,l=this._imageParams.xOffset,m=this._imageParams.yOffset;e?j=Math.ceil(this._baseline-d)-.5:j=Math.floor(this._baseline+d)+.5,this._context.beginPath(),this._context.moveTo(g,i),this._context.lineTo(g,j),this._context.lineTo(h,j),this._context.lineTo(h,i),this._context.strokeStyle=a.markup.colour,this._context.stroke(),this._context.closePath(),this._context.restore();var n={};if(a.markup.metadata){var o=a.markup.metadata;n.title=o.type||"Bridge",n.body='<div class="tipContent">  <dl>    <dt>Coordinates:</dt>    <dd>'+o.start+"-"+o.end+"</dd>"+"    <dt>Source:</dt>"+"    <dd>"+(o.database||'<span class="na">n/a</span>')+"</dd>"+"  </dl>"+"</div>"}var p=[i,j].sort(function(a,b){return a-b});this._areasList.push({start:b,type:"bridge-start",colour:f,end:c,tip:n,coords:[l+g-1,m+p[0]-1,l+g+1,m+p[1]+1]}),this._areasList.push({start:b,type:"bridge-horizontal",colour:f,end:c,tip:n,coords:[l+g-1,m+p[0],l+h+1,m+p[0]+2]}),this._areasList.push({start:b,type:"bridge-end",colour:f,end:c,tip:n,coords:[l+h-1,m+p[0]-1,l+h+1,m+p[1]+1]})},_drawRegion:function(a){$jq.inArray(a.startStyle,this._markupSpec.regionEndValues)>-1||this._throw("region start style is not valid: '"+a.startStyle+"'"),$jq.inArray(a.endStyle,this._markupSpec.regionEndValues)>-1||this._throw("region end style is not valid: '"+a.endStyle+"'");var b=Math.floor(this._regionHeight)-2,c=Math.round(b/2),d=c,e=(a.end-a.start+1)*this._imageParams.residueWidth,f=Math.max(1,Math.floor(a.start*this._imageParams.residueWidth)+1),g=Math.floor(this._baseline-c)+.5,h={x:f,y:g,w:e,h:b,r:c,a:d,s:a.startStyle,e:a.endStyle},i=this._context.createLinearGradient(f,g,f,g+b);i.addColorStop(0,"#ffffff"),i.addColorStop(.5,a.colour),i.addColorStop(.7,a.colour),i.addColorStop(1,"#ffffff"),this._context.save(),this._context.beginPath(),this._buildRegionPath(h),this._context.fillStyle=i,this._context.fill();var j;a.aliStart!==undefined&&a.aliEnd!==undefined&&(j=this._drawEnvelope(a,c,b)),this._context.strokeStyle=a.colour,this._context.stroke(),this._context.closePath(),this._context.beginPath(),this._context.moveTo(0,this._topOffset),this._context.lineTo(0,this._botOffset),this._context.strokeStyle="white",this._context.stroke(),this._context.closePath(),this._options.labels&&this._drawText(f,this._baseline,e,a.text),this._context.restore();var k=this._imageParams.xOffset,l=this._imageParams.yOffset,m={text:a.text,type:"region",start:a.start,end:a.end,colour:a.colour,aliStart:a.aliStart,aliEnd:a.aliEnd,coords:[k+f,l+g,k+f+e+1,l+g+b]};this._areasList.push(m),this._areasHash["region_"+a.text+"_"+a.start+"_"+a.end]=m,a.href!==undefined&&(m.href=a.href),this._buildTip(a,m)},_buildTip:function(a,b){if(a.metadata===undefined)return;var c=a.metadata,d;c.accession!==undefined&&c.identifier!==undefined?d=c.identifier+" ("+c.accession.toUpperCase()+")":c.identifier!==undefined?d=c.identifier:c.accession!==undefined?d=c.accession.toUpperCase():d=c.type;var e='<span class="inactive">n/a</span>';c.start!==undefined&&c.end!==undefined&&(e=c.start+" - "+c.end,c.aliStart!==undefined&&c.aliEnd!==undefined&&(e=e.concat(" (alignment region "+c.aliStart+" - "+c.aliEnd+")")));var f='<div class="tipContent">  <dl>    <dt>Description:</dt>    <dd>'+(c.description||'<span class="inactive">n/a</span>')+"</dd>"+"    <dt>Coordinates:</dt>"+"    <dd>"+e+"</dd>"+"    <dt>Source:</dt>"+"    <dd>"+(c.database||'<span class="na">n/a</span>')+"</dd>"+"  </dl>"+"</div>";b.tip={title:d,body:f}},_drawMotif:function(a){a.start=parseInt(a.start,10),a.end=parseInt(a.end,10);var b=this._imageParams.motifHeight,c=Math.floor((a.end-a.start+1)*this._imageParams.residueWidth)+1,d=Math.max(1,Math.floor((a.start+1)*this._imageParams.residueWidth)),e=Math.floor(this._baseline-Math.round(b/2));this._context.save();var f;if(a.colour instanceof Array){a.colour.length!==3&&this._throw("motifs must have either one or three colours"),colour=[];var g=this._getRGBColour.bind(this),h=this._imageParams;a.colour.each(function(a){var b=g(a);colour.push({rgb:"rgb("+b.join(",")+")",rgba:"rgba("+b.join(",")+","+h.motifOpacity+")"})});var i=Math.round(b/3);for(var j=0;j<3;j=j+1)this._context.fillStyle=colour[j].rgb,this._context.fillRect(d,e+i*j,c,i)}else{colour=this._getRGBColour(a.colour);var k="rgb("+colour.join(",")+")",l="rgba("+colour.join(",")+","+this._imageParams.motifOpacity+")";this._context.fillStyle=l,this._context.fillRect(d,e,c,parseInt(b,10)+1)}this._context.restore();var m;a.metadata!==undefined&&a.metadata.identifier!==undefined?m=a.metadata.identifier:a.text!==undefined?m=a.text:m="motif, "+a.start+" - "+a.end;var n=this._imageParams.xOffset,o=this._imageParams.yOffset,p={text:m,type:"motif",start:a.aliStart||a.start,end:a.aliEnd||a.end,colour:colour,coords:[n+d,o+e,n+d+c,o+e+b]};this._areasList.push(p),this._areasHash["motif_"+m+"_"+a.start+"_"+a.end]=p,a.href!==undefined&&(p.href=a.href),this._buildTip(a,p)},_buildRegionPath:function(a){switch(a.s){case"curved":this._context.moveTo(a.x+a.r,a.y),this._drawLeftRounded(a.x,a.y,a.r,a.h);break;case"jagged":this._context.moveTo(a.x,a.y),this._drawJagged(a.x,a.y,a.h,!0);break;case"straight":this._context.moveTo(a.x,a.y),this._context.lineTo(a.x,a.y+a.h);break;case"arrow":this._context.moveTo(a.x+a.a,a.y),this._drawLeftArrow(a.x,a.y,a.a,a.h)}switch(a.e){case"curved":this._context.lineTo(a.x+a.w-a.r,a.y+a.h),this._drawRightRounded(a.x,a.y,a.r,a.h,a.w);break;case"jagged":this._context.lineTo(a.x+a.w,a.y+a.h),this._drawJagged(a.x+a.w,a.y+a.h,a.h,!1);break;case"straight":this._context.lineTo(a.x+a.w,a.y+a.h),this._context.lineTo(a.x+a.w,a.y);break;case"arrow":this._context.lineTo(a.x+a.w-a.a,a.y+a.h),this._drawRightArrow(a.x+a.w-a.a,a.y+a.h,a.a,a.h)}a.s==="curved"||a.s==="arrow"?this._context.lineTo(a.x+a.r,a.y):this._context.lineTo(a.x,a.y)},_drawEnvelope:function(a,b,c){parseInt(a.start,10)>parseInt(a.aliStart,10)&&this._throw("regions must have start <= aliStart ("+a.start+" is > "+a.aliStart+")"),parseInt(a.end,10)<parseInt(a.aliEnd,10)&&this._throw("regions must have end >= aliEnd ("+a.end+" is < "+a.aliEnd+")");var d=this._baseline-b,e=this._imageParams.residueWidth,f,g;a.aliStart&&a.aliStart>a.start&&(f={x:Math.floor(a.start*e),y:Math.floor(d-1)+1,w:Math.floor(a.aliStart*e)-Math.floor(a.start*e)+1,h:c+1}),a.aliEnd&&a.aliEnd<a.end&&(g={x:Math.floor(a.aliEnd*e)+1,y:Math.floor(d-1)+1,w:Math.floor(a.end*e)-Math.floor(a.aliEnd*e),h:c+1}),this._context.save(),this._context.globalCompositeOperation="source-atop";var h="rgba(255,255,255,"+this._imageParams.envOpacity+")";this._context.fillStyle=h,f!==undefined&&this._context.fillRect(f.x,f.y,f.w,f.h),g!==undefined&&this._context.fillRect(g.x,g.y,g.w,g.h),this._context.restore()},_drawText:function(a,b,c,d){this._context.save(),this._context.font="bold 12px 'optimer'",this._context.textAlign="center",this._context.textBaseline="middle";var e=this._context.measureText(d),f=e.width+Math.round(this._regionHeight/3),g=e.height;if(f>c){this._context.restore();return}if(g>this._regionHeight){this._context.restore();return}var h=a+c/2;this._context.lineWidth=2,this._context.strokeStyle="#eeeeee",this._context.strokeText(d,h,b),this._context.fillStyle="#000000",this._context.fillText(d,h,b),this._context.restore()},_drawLeftRounded:function(a,b,c,d){this._context.quadraticCurveTo(a,b,a,b+c),this._context.quadraticCurveTo(a,b+d,a+c,b+d)},_drawRightRounded:function(a,b,c,d,e){this._context.quadraticCurveTo(a+e,b+d,a+e,b+c),this._context.quadraticCurveTo(a+e,b,a+e-c,b)},_drawJagged:function(a,b,c,d){var e=parseInt(this._imageParams.largeJaggedSteps,10);e+=e%2;var f=this._getSteps(c,e),g=c/e;for(var h=0;h<f.length;h=h+1)h%2!==0?d?this._context.lineTo(a,b+f[h]):this._context.lineTo(a,b-f[h]):d?this._context.lineTo(a+g,b+f[h]):this._context.lineTo(a-g,b-f[h]);d?this._context.lineTo(a,b+c):this._context.lineTo(a,b-c)},_getSteps:function(a,b){var c="shifts_"+a+"_"+b,d=this._cache[c];if(d===undefined){var e=a/b,f=[];for(var g=0;g<b/2;g=g+1)f.push(a/2-g*e),f.push(a/2+g*e);d=f.uniq().sort(function(a,b){return a-b}),this._cache[c]=d}return d},_drawLeftArrow:function(a,b,c,d){this._context.lineTo(a,b+c),this._context.lineTo(a+c,b+d)},_drawRightArrow:function(a,b,c,d){this._context.lineTo(a+c,b-d+c),this._context.lineTo(a,b-d)},_drawHighlight:function(){var a=this._imageParams.xOffset,b=this._imageParams.yOffset,c=Math.round(this._imageParams.highlightWeight/2),d=Math.floor(a+this._sequence.highlight.start*this._imageParams.residueWidth),e=Math.ceil(b+this._sequence.highlight.end*this._imageParams.residueWidth),f=this._canvasHeight-4-c,g=this._canvasHeight-2;this._imageParams.highlightWeight%2&&(d-=.5,e-=.5,g-=.5),this._context.save(),this._context.beginPath(),this._context.strokeStyle=this._imageParams.highlightColour,this._context.lineWidth=this._imageParams.highlightWeight,this._context.moveTo(d,f),this._context.lineTo(d,g),this._context.lineTo(e,g),this._context.lineTo(e,f),this._context.stroke(),this._context.restore();var h={start:this._sequence.highlight.start,end:this._sequence.highlight.end,coords:[d,f,e,g],tip:{title:this._sequence.highlight.text||"Highlighted region",body:'<div class="tipContent">  <dl>    <dt>Start:</dt>    <dd>'+this._sequence.highlight.start+"</dd>"+"    <dt>End:</dt>"+"    <dd>"+this._sequence.highlight.end+"</dd>"+"  </dl>"+"</div>"}};this._areasList.push(h)},_getRGBColour:function(a){var b=/^#?([A-F0-9]{6})$/i.exec(a),c=/^#?([A-F0-9]{3})$/i.exec(a),d,e,f,g,h;return b===null&&c===null&&this._throw("not a valid hex colour ('"+a+"')"),b!==null?(d=b[1],e=parseInt(d.substring(0,2),16),f=parseInt(d.substring(2,4),16),g=parseInt(d.substring(4,6),16)):c!==null&&(d=c[1],e=parseInt(""+d.substring(0,1)+d.substring(0,1),16),f=parseInt(""+d.substring(1,2)+d.substring(1,2),16),g=parseInt(""+d.substring(2,3)+d.substring(2,3),16)),h=[e,f,g],h.r=e,h.g=f,h.b=g,h},_getHexColour:function(a,b,c){var d,e,f;a.shift?(d=a[0],e=a[1],f=a[2]):a.r!==undefined&&a.g!==undefined&&a.b!==undefined?(d=a.r,e=a.g,f=a.b):(d=a,e=b,f=c);var g=[d,e,f].collect(function(a){return a===undefined&&this._throw("need all three RGB colour values"),isNaN(a)&&this._throw("failed to get a valid RGB colour triplet"),a=parseInt(a,10),a=Math.max(0,a),a=Math.min(a,255),a}),h=g.collect(function(a){return"0123456789abcdef".charAt((a-a%16)/16)+"0123456789abcdef".charAt(a%16)}).join("");return"#"+h}};this.PfamGraphic=PfamGraphic